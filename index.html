<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Â¿QuÃ© comemos hoy?</title>

<style>
body { font-family: Arial; background:#f3f4f6; padding:20px; }
.card { max-width:500px; margin:auto; background:white; padding:20px; border-radius:16px; }
button { padding:6px 10px; border:none; border-radius:8px; margin:2px; cursor:pointer; }
.votar { background:#22c55e; color:white; }
.quitar { background:#f97316; color:white; }
.borrar { background:#ef4444; color:white; }
.agregar { background:#3b82f6; color:white; }
.cerrar { background:#8b5cf6; color:white; }
input, textarea { padding:6px; width:100%; margin-top:5px; }
hr { margin:15px 0; }
</style>
</head>

<body>
<div class="card" id="app"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const PERSONAS = ["MamÃ¡","PapÃ¡","Alfre","Benja"];
const hoy = new Date().toISOString().split("T")[0];
let persona = "";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDqqKDKvGb3jGA_Zvwf51-hR0mxXmlmzl0",
  authDomain: "comida-3e1c1.firebaseapp.com",
  projectId: "comida-3e1c1",
  storageBucket: "comida-3e1c1.appspot.com",
  messagingSenderId: "266746473738",
  appId: "1:266746473738:web:7b758f47cfc6310f7d9ef3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- APP ---------- */
function render(){
  const app = document.getElementById("app");

  if(!persona){
    app.innerHTML = `
      <h2>Â¿QuiÃ©n vota?</h2>
      ${PERSONAS.map(p=>`<button onclick="elegirPersona('${p}')">${p}</button>`).join("")}
    `;
    return;
  }

  db.collection("votosPorDia").doc(hoy).get().then(doc=>{
    let data = doc.exists ? doc.data() : {
      almuerzo: [],
      merienda: [],
      cerrado: false,
      resultado: {}
    };

    app.innerHTML = `
      <h2>ğŸ½ï¸ Comidas del dÃ­a</h2>
      <p>Votando como <b>${persona}</b></p>
      <button onclick="cambiarPersona()">Cambiar persona</button>

      ${renderSeccion("Almuerzo","almuerzo",data)}
      <hr>
      ${renderSeccion("Merienda","merienda",data)}

      <hr>
      <button class="cerrar" onclick="cerrarDia()">ğŸ”’ Cerrar dÃ­a</button>

      <hr>
      <h3>ğŸ“… Historial</h3>
      <ul id="historial"></ul>
    `;

    cargarHistorial();
  });
}

function renderSeccion(titulo,tipo,data){
  const lista = data[tipo];
  const ganador = lista.length
    ? lista.reduce((a,b)=>a.votos>b.votos?a:b).nombre
    : "â€”";

  return `
    <h3>${titulo}</h3>
    <p>ğŸ¥‡ Ganador actual: <b>${ganador}</b></p>

    <ul>
      ${lista.map((p,i)=>`
        <li>
          <b>${p.nombre}</b> (${p.votos})
          <br><small>${p.ingredientes || ""}</small><br>
          <button class="votar" onclick="votar('${tipo}',${i},1)">+ Votar</button>
          <button class="quitar" onclick="votar('${tipo}',${i},-1)">- Quitar</button>
          <button class="borrar" onclick="borrar('${tipo}',${i})">âŒ</button>
        </li>
      `).join("")}
    </ul>

    <input id="${tipo}-nombre" placeholder="Nuevo plato">
    <textarea id="${tipo}-ing" placeholder="Ingredientes"></textarea>
    <button class="agregar" onclick="agregar('${tipo}')">Agregar</button>
  `;
}

/* ---------- ACCIONES ---------- */
function elegirPersona(p){ persona=p; render(); }
function cambiarPersona(){ persona=""; render(); }

function votar(tipo,i,delta){
  const ref = db.collection("votosPorDia").doc(hoy);
  ref.get().then(doc=>{
    let data = doc.data();
    data[tipo][i].votos = Math.max(0, data[tipo][i].votos + delta);
    ref.set(data).then(render);
  });
}

function borrar(tipo,i){
  const ref = db.collection("votosPorDia").doc(hoy);
  ref.get().then(doc=>{
    let data = doc.data();
    data[tipo].splice(i,1);
    ref.set(data).then(render);
  });
}

function agregar(tipo){
  const nombre = document.getElementById(tipo+"-nombre").value.trim();
  const ing = document.getElementById(tipo+"-ing").value.trim();
  if(!nombre) return;

  const ref = db.collection("votosPorDia").doc(hoy);
  ref.get().then(doc=>{
    let data = doc.exists ? doc.data() : {almuerzo:[], merienda:[]};
    data[tipo].push({nombre, votos:0, ingredientes: ing});
    ref.set(data).then(render);
  });
}

function cerrarDia(){
  const ref = db.collection("votosPorDia").doc(hoy);
  ref.get().then(doc=>{
    let data = doc.data();

    const alm = data.almuerzo.length
      ? data.almuerzo.reduce((a,b)=>a.votos>b.votos?a:b).nombre
      : "â€”";
    const mer = data.merienda.length
      ? data.merienda.reduce((a,b)=>a.votos>b.votos?a:b).nombre
      : "â€”";

    data.cerrado = true;
    data.resultado = { almuerzo: alm, merienda: mer };

    ref.set(data).then(render);
  });
}

function cargarHistorial(){
  db.collection("votosPorDia").get().then(snap=>{
    document.getElementById("historial").innerHTML =
      snap.docs
        .filter(d=>d.data().cerrado)
        .map(d=>`<li>${d.id} â†’ ğŸ½ï¸ ${d.data().resultado.almuerzo} / â˜• ${d.data().resultado.merienda}</li>`)
        .join("");
  });
}

render();
</script>
</body>
</html>
